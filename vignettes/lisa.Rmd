---
title: "Lisa - motif enrichments and more"
author: "Lukas Burger, Michael Stadler"
date: "`r Sys.Date()`"
bibliography: lisa-refs.bib
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  out.width = "80%",
  fig.align = "center"
)
```

<img src="lisa_logo_v1.png" style="display: block; margin-left: auto; margin-right: auto; width: 50%; border: 0" />

# Introduction

`lisa` makes use of her father [Homer](http://homer.ucsd.edu/homer/index.html)
to look for enriched motifs in sets of genomic regions, compared to all other regions.

The motifs come from a collection of transcription factor binding site specificities,
such as `JASPAR2018`.

The regions could be for example promoters or accessible regions.

The regions are grouped into bins according to a numerical value assigned to each
bin, such as change of expression or accessibility.

Finally, `lisa` can also be used to look for motifs in sequences.

# Quick example: Identify enriched motifs

```{r, quick, eval=FALSE}
# load package
library(lisa)

# bin regions
# (atac.peaks.change is a numberical vector)
bins <- bin(x = atac.peaks.change, binmode = "equalN", nElement = 400)

# dump motifs into file
motiffile <- dumpJaspar("jaspar2018.motif", pkg = "JASPAR2018")

# find Homer (findMotifsGenome.pl)
homerfile <- findHomer(dirs = "/path/to/look/into")

# run analysis
# (atac.peaks is a GRanges)
resL <- runHomer(gr = atac.peaks, b = bins, genomedir = "/work/gbioinfo/DB/genomes/mm10",
                 outdir = "myresults", motifFile = "jaspar2018.motif", homerfile = homerfile,
                 regionsize = "given", Ncpu = 4L)

```

`resL` is a list with components *p*, *FDR*, *enr* and *log2enr*, each containing a matrix
with motifs (rows) by bins (columns). The values are:  

- *p*: the raw P value ($-\log_{10} p$) of a given motif enrichment in a given bin,
  as reported by Homer. Each P value results from a Homer analysis testing each
  motif occuring within the bin, compared to its occurrences in all other bins
  as a background.  
- *FDR*: Same as *p* but adjusted for multiple testing using the method of
  Benjamini and Hochberg, 1995 (`p.adjust(..., method="fdr"`).  
- *enr*: Motif enrichments, calculated as: $enr = (o - e) / \sqrt e$, where $o$ and
  $e$ are the observed and expected numbers of regions in the bin containing a
  given motif. These enrichments correspond to $z$ values ($z = (z - \mu)/\sigma$),
  assuming that the numbers of regions in a bin that contain a motif are independent
  Poisson random variables with mean and variance $e$.
- *log2enr*: Motif enrichments, calculated as: $log2enr = log2((o + 8)/(e + 8))$,
  where $o$ and $e$ are the observed and expected numbers of regions in the bin
  containing a given motif.


# Detailed example: Finding TFs enriched in differentially methylated regions

The detailed example is based on an in vitro differentiation system, in which
mouse embryonic stem (ES) cells are differentiated into neuronal progenitors (NP).
In an earlier study [@LMRs], we have analyzed the genome-wide CpG methylation patterns
in these cell types and identified so call *low methylated regions* (LMRs), that
have reduced methylation levels and correspond to regions bound by transcription
factors.

We have later published a tool that systematically identifies such regions from
genome-wide methylation data [@MethylSeekR]. Interestingly, a change in methylation
of LMRs is indicative of altered transcription factor binding. We will therefore
use these regions to identify TF motifs that are enriched/depleted in LMR regions
that change their methylation between ES and NP cell states.


## Load library
We start by loading the needed libraries:  
```{r loadlib, message=FALSE}
library(GenomicRanges)
library(lisa)
```

## Genomic regions of interest
`lisa` contains a file with genomic coordinates (mouse mm9 assembly) of LMRs,
with the respective changes of methylation:  
```{r loadLMRs}
lmrfile <- system.file("extdata", "LMRsESNPmerged.gr.rds", package = "lisa")
lmr <- readRDS(lmrfile)
lmr
```

You can see there are `r length(lmr)` LMRs, most of which gain methylation between
ES and NP stages:  
```{r deltameth}
hist(lmr$deltaMeth, 100, col="gray", main="",
     xlab="Change of methylation (NP - ES)", ylab="Number of LMRs")
```

In order to keep the computation time reasonable, we'll select 10,000 of the LMRs randomly:  
```{r lmrsel}
set.seed(1)
lmrsel <- lmr[ sample(x = length(lmr), size = 10000, replace = FALSE) ]
```


## Bin genomic regions
Now let's bin our LMRs by how much they change methylation, using the `bin` function.
We are not interested in small changes of methylation, say less than 0.3, so we'll
use the `minAbsX` argument to create a *no-change* bin in [-0.3, 0.3). The remaining
LMRs are put into bins of 800 each:  
```{r binlmrs}
bins <- bin(x = lmrsel$deltaMeth, binmode = "equalN", nElement = 800, minAbsX = 0.3)
table(bins)
```

Because of the asymmetry of methylation changes, there is only a single bin with LMRs
that lost methylation and many that gained:  
```{r plotbins}
plotBinDensity(lmrsel$deltaMeth, bins, legend = "topleft")
```

Note that the bin-breaks around the *no-change* bin are not exactly -0.3 to 0.3.
They have been adjusted to have the required 800 LMRs per bin.

## Prepare motif enrichment analysis
Next we prepare the Homer-based motif enrichment analysis. We first need to create
a file with the motifs that we are interested in. A simple way is to dump the vertebrate
motifs from the `JASPAR2018` package into a file:  
```{r dumpjaspar}
motiffile <- tempfile(fileext = ".motif")
dumpJaspar(motiffile, pkg = "JASPAR2018", relScoreCutoff = 0.9)
```

Next we need to know where Homer is installed (you may have to adjust the `dirs`
argument below according to your environment):  
```{r homerscript}
homerfile <- findHomer(dirs = "/work/gbioinfo/Appz/Homer/Homer-4.8/bin/")
```

## Run motif enrichment analysis
Finally, we run the analysis. Again, you may have to adjust the `genomedir`.

This step may take a while, for this reason you do not need to run it, but can just load the results as shown below:  
```{r runhomer, eval=FALSE}
outdir <- tempfile(fileext = ".output")
resL <- runHomer(gr = lmrsel, b = bins, genomedir = "/work/gbioinfo/DB/genomes/mm9",
                 outdir = outdir, motifFile = motiffile, homerfile = homerfile,
                 regionsize = "given", Ncpu = 20L)
```

<!--
saveRDS(resL, "/work/gbioinfo/stadler/development/R/compbio-lisa/inst/extdata/resL.rds")
-->

In case you did not run the above code, let's now read in the results:  
```{r gethomerresults}
resL <- readRDS(system.file("extdata", "resL.rds", package = "lisa"))
```

We can plot the results using the `plotMotifHeatmaps` function, e.g. selecting all factors that have an absolute log2 enrichment of at least 1.0 in any bin:  
```{r plottfs}
# select strongly enriched TFs
sel <- apply(resL[["log2enr"]], 1, function(x) max(abs(x))) > 1.0
sum(sel)
resLsel <- lapply(resL, function(x) x[sel,])
# shorten names
resLsel <- lapply(resLsel, function(x) { rownames(x) <- sub("\\|.*$","",rownames(x)); x })
# plot
plotMotifHeatmaps(x = resLsel, b = bins, which.plots = c("log2enr","FDR"), width = 2.0,
                  cluster=TRUE, maxEnr = 2, maxSig = 10)
```


# Use `lisa` to annotate genomic regions with predicted motifs

As mentioned `lisa` can also be used to scan sequences for motifs. Here is an
example (just on few sequences/motifs for illustration):

```{r findMotifs}
# get sequences of promoters as a DNAStringSet
# (could also be a single DNAString, or the name of a fasta file)
library(TxDb.Hsapiens.UCSC.hg19.knownGene)
gr <- promoters(TxDb.Hsapiens.UCSC.hg19.knownGene, upstream = 1000, downstream = 500)[c(1,4,5,10)]
library(BSgenome.Hsapiens.UCSC.hg19)
seqs <- getSeq(BSgenome.Hsapiens.UCSC.hg19, gr)
seqs

# get motifs as a PWMatrixList
# (could also be a single PWMatrix, or the name of a motif file)
library(JASPAR2018)
library(TFBSTools)
pwms <- getMatrixSet(JASPAR2018, list(matrixtype="PWM", tax_group="vertebrates"))
pwms <- pwms[c("MA0885.1","MA0099.3","MA0033.2","MA0037.3","MA0158.1")]
pwms

# predict hits in sequences
res <- findMotifHits(query = pwms, subject = seqs, min.score = 6.0, method = "matchPWM")
res

# ... or using method = "homer2"
homerfile <- findHomer(homerfile = "homer2", dirs = "/work/gbioinfo/Appz/Homer/Homer-4.8/bin/")
res2 <- findMotifHits(query = pwms, subject = seqs, min.score = 6.0, method = "homer2", homerfile = homerfile)
res2

summary(res %in% res2)

# create hit matrix:
# number of site of each motif per sequence
m <- table(seqnames(res), as.character(res$pwmname))
m
```

<!--
REMARK: findMotifHits(..., method="homer2") seems to differ from matchPWM:
- homer2 needs base probabilities rather than log2-odds
- homer2 uses natural logarithm rather than log2

potential solution for method="homer2":
- convert PWM into pseudo-PWM with base probabilities (see pwms4 below)
- convert min.score to natural log to run homer2
- convert homer2 reported scores back to log2 scale

# create pseudo-pwm for homer2 (probabilities instead of log2-odd scores)
pfms3 <- getMatrixSet(JASPAR2018, list(matrixtype="PFM", tax_group="vertebrates"))
pfms3 <- pfms3[c("MA0885.1","MA0099.3","MA0033.2","MA0037.3","MA0158.1")]
pwms3 <- do.call(PWMatrixList, lapply(pfms3, function(x) { y <- toPWM(x); Matrix(y) <- sweep(Matrix(x), 2, colSums(Matrix(x)), "/"); y }))

# create pseudo-pwm for homer2 converting from log2-odds score pwm
pwms4 <- do.call(PWMatrixList, lapply(pwms, function(x) { y <- (2^Matrix(x) / bg(x)); Matrix(x) <- sweep(y, 2, colSums(y), "/"); x }))

homerfile <- findHomer(homerfile = "homer2", dirs = "/work/gbioinfo/Appz/Homer/Homer-4.8/bin/")
matchPWM(pwm = Matrix(pwms[[1]]), subject = seqs[[2]], min.score = "80%", with.score = TRUE) # only + strand hits
matchPWM(pwm = Matrix(pwms[[1]]), subject = reverseComplement(seqs[[2]]), min.score = "80%", with.score = TRUE) # only - strand hits
as(searchSeq(x = pwms[1], subject = seqs[2], min.score = 0.98), "DataFrame")
findMotifHits(query = pwms[1],  subject = seqs[2], min.score = 8.0, method = "matchPWM")
findMotifHits(query = pwms3[1], subject = seqs[2], min.score = log(2^8.0), method = "homer2", homerfile = homerfile)
findMotifHits(query = pwms4[1], subject = seqs[2], min.score = log(2^8.0), method = "homer2", homerfile = homerfile)
reverseComplement(seqs[[2]][IRanges(247,254)]) # bug in homer2 parsing code in conveting - strand coordinates

-->

# Session info and logo
The lisa logo uses a drawing that was obtained from http://vectorish.com/lisa-simpson.html
under the Creative Commons attribution - non-commercial 3.0 license: https://creativecommons.org/licenses/by-nc/3.0/.

This vignette was built using:  
```{r, session}
sessionInfo(package = "lisa")
```

# References
